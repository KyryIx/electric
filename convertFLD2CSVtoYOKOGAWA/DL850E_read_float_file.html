<html>
	<head>
		<title>DL850E Read Float File to Numbers</title>
		<script>
			/*****************************************************************
			 *****************		Example developed by:       **************
			 *****************		Everton Pereira da Cruz     **************
			 *****************		kyry.ix@gmail.com           **************
			 *****************		http://www.everton.mat.br   **************
			******************************************************************/
			
			function init(){
				var values = [ 1042284544, 1071029508, 1071015527, -1071015528, -2134720672 ]; //  s    expoent                 fraction
				//  1042284544(10) = 0011.1110..0010.0000..0000.0000..0000.0000(2) => [0] [0111.1100] [010.0000..0000.0000..0000.0000] // criado por wikipedia
				//  1071029508(10) = 0011.1111..1101.0110..1001.1101..0000.0100(2) => [0] [0111.1111] [101.0110..1001.1101..0000.0100]
				//  1071015527(10) = 0011.1111..1101.0110..0110.0110..0110.0111(2) => [0] [0111.1111] [101.0110..0110.0110..0110.0111]
				// -1071015528(10) = 1100.0000..0010.1001..1001.1001..1001.1000(2) => [1] [1000.0000] [010.1001..1001.1001..1001.1000] // criado por mim
				// -2134720672(10) = 1000.0000..1100.0010..1011.1111..0110.0000(2) => [1] [0000.0001] [100.0010..1011.1111..0110.0000] // criado por mim
				//window.document.write( values[0] + ': ' );
				//window.document.write( int32toIEEEFloat( values[0] ) + '<br/>\n' );
				
				for( var i=0; i<values.length; i++ ){
					window.document.write( values[i] + ' ==> ' + toBinary(values[i]) + ' ==> ' + int32toIEEEFloat(values[i]) + '<br/>\n' );
				}
			}
			//window.onload=init;
			
			// ************************************************************** //
			// * DEVELOPER: Everton Pereira da Cruz                         * //
			// * FUNCTION:  Convert to binary                               * //
			// ************************************************************** //
			function toBinary( int32Value ){
				var result = '';
				for( var i=0; i<32; i++ ){
					if( (i % 4 == 0) && (i != 0) ){
						result = '.' + result;
					}
					result = ((int32Value >>i) & 1) + result;
				}
				return result;
			}
			
			// ************************************************************** //
			// * DEVELOPER: Everton Pereira da Cruz                         * //
			// * FUNCTION:  Convert to IEEE float                           * //
			// ************************************************************** //
			function int32toIEEEFloat( int32Value ){
				// bit 31
				var sign = (int32Value >> 31) & 1;
				// bits 30 ~ 23 => 1111.1111(2) = 0xFF(16)
				var expoent = (int32Value >> 23) & 0xFF;
				// bits 22 ~ 0 => 111.1111..1111.1111..1111.1111(2) = 0x7FFFFF
				//var fraction = int32Value & 0x7FFFFF;
				var fraction = 1;
				for( var i=1; i<=23; i++ ){
					fraction += ((int32Value >> (23-i)) & 1) * Math.pow( 2,(-1)*i );
				}
				
				var value = (sign==1?-1:1) * Math.pow(2, expoent - 127) * fraction;
				return value;
			}
			
			// ************************************************************** //
			// * DEVELOPER: https://stackoverflow.com/questions/3665115/create-a-file-in-memory-for-user-to-download-not-through-server/18197341#18197341?newreg=d42f55ec6dac4d308a47cca810425c22 * //
			// *            Adapted by Everton Pereira da Cruz
			// * FUNCTION:  Generate contents to CSV                        * //
			// ************************************************************** //
			function download( filename, string ){
				var element_temp = window.document.createElement( 'a' );
				element_temp.setAttribute( 'href', 'data:text/csv;charset=utf-8,' + encodeURIComponent( string ) );
				element_temp.setAttribute( 'download', filename );
				element_temp.style.display = 'none';
				window.document.body.appendChild( element_temp );
				element_temp.click();
				window.document.body.removeChild( element_temp );
			}
			
			// ************************************************************** //
			// * DEVELOPER: Everton Pereira da Cruz                         * //
			// * FUNCTION:  Treatment file FLD                              * //
			// ************************************************************** //
			function loadFile() {
				// https://www.html5rocks.com/en/tutorials/file/dndfiles/ //
				// https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Basico_sobre_HTTP/MIME_types
				// https://developer.mozilla.org/en-US/docs/Web/API/FileReader
				// https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsArrayBuffer
				// https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsBinaryString
				// https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsText
				// https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL //
				// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer
				// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer/byteLength
				// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Int32Array
				// https://pt.wikipedia.org/wiki/IEEE_754
				// https://en.wikipedia.org/wiki/Single-precision_floating-point_format
				// https://www.mimosa.org/ieee-floating-point-format/
				// https://tmi.yokogawa.com/br/library/resources/faqs/how-can-i-read-and-access-the-data-of-a-dl850-fld-file/
				// https://tmi.yokogawa.com/library/resources/faqs/xviewer-fld-floating-data-format-information/
				if( window.File && window.FileReader && window.FileList && window.Blob ){
					//var file   = document.querySelector('input[type=file]').files[0];
					var file   = document.getElementById('file').files[0];
					var reader = new FileReader();
					reader.addEventListener( "load", function (){
						const buffer = reader.result;
						const size   = buffer.byteLength;
						const view   = new Int32Array(buffer);
						var result   = '';
						
						window.document.write( 'Length: ' + view.length + '<br/>\n' );
						for( var i=0; i<view.length; i++ ){
							window.document.write( i + ' - ' + view[i] + ' ==> ' + int32toIEEEFloat( view[i] ) + ' V<br/>\n' );
							result += i + ',' + int32toIEEEFloat( view[i] ) + '\r\n';
						}
						download( 'signal.csv', result );
					}, false );
					
					if( file ){
						reader.readAsArrayBuffer(file);
						//reader.readAsBinaryString(file);
						//reader.readAsText(file, 'UTF-8');
						//reader.readAsDataURL(file);
					}
				}
				else {
					alert( 'The File APIs are not fully supported in this browser.' );
				}
			}
		</script>
	</head>
	<body>
		Escolha seu arquivo *.FLD:
		<input type="file" id="file" required onchange="loadFile();" accept="*/*" />
	</body>
</html>
		